<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: -apple-system, BlinkMacSystemFont, "Barlow", 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: white;
            overflow: hidden;
            touch-action: manipulation;
        }

        .camera-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .video-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            z-index: 20;
        }

        .controls-row {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
        }

        .zoom-controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .zoom-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }

        .zoom-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .zoom-btn:active {
            transform: scale(0.95);
        }

        .zoom-btn.active {
            background: rgba(255,255,255,0.4);
            border: 2px solid white;
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
            padding: 5px;
            backdrop-filter: blur(10px);
            margin-bottom: 15px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .mode-btn {
            background: none;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: rgba(255,255,255,0.3);
        }

        .control-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .capture-btn {
            width: 80px;
            height: 80px;
            background: white;
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .capture-btn:hover {
            transform: scale(1.05);
        }

        .capture-btn:active {
            transform: scale(0.95);
            background: #f0f0f0;
        }

        .capture-btn.recording {
            background: #ff4444;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .gallery-preview {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.3);
            cursor: pointer;
            overflow: hidden;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            left: 20px;
        }

        .gallery-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .switch-btn {
            position: absolute;
            right: 20px;
        }

        .flash-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 30;
        }

        .flash-overlay.active {
            animation: flash 0.2s ease-out;
        }

        @keyframes flash {
            0% { opacity: 0; }
            50% { opacity: 0.8; }
            100% { opacity: 0; }
        }

        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 40;
        }

        .photos-grid {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: black;
            z-index: 50;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }

        .photos-grid.active {
            display: block;
        }

        .photos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .photos-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .photo-item {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .photo-item:hover .delete-btn {
            opacity: 1;
        }

        .photo-item img,
        .photo-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.8);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .delete-btn:hover {
            background: rgba(255, 0, 0, 1);
        }

        @media (max-width: 768px) {
            .control-btn {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }

            .capture-btn {
                width: 70px;
                height: 70px;
            }

            .controls {
                padding: 15px;
            }

            .zoom-btn {
                width: 37px;
                height: 37px;
                font-size: 14px;
            }

            .gallery-preview {
                width: 50px;
                height: 50px;
                left: 15px;
            }

            .switch-btn {
                right: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="camera-container">
        <div class="video-container">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="canvas" style="display: none;"></canvas>
            
            <div class="flash-overlay" id="flashOverlay"></div>
        </div>

        <div class="controls">
            <div class="mode-selector">
                <button class="mode-btn active" data-mode="photo">PHOTO</button>
                <button class="mode-btn" data-mode="video">VIDEO</button>
            </div>
            
            <div class="zoom-controls">
                <button class="zoom-btn" data-zoom="1">1x</button>
                <button class="zoom-btn" data-zoom="2">2x</button>
                <button class="zoom-btn" data-zoom="4">4x</button>
                <button class="zoom-btn" data-zoom="8">8x</button>
            </div>
            
            <div class="controls-row">
                <div class="gallery-preview" id="galleryBtn">
                    ðŸ“·
                </div>
                
                <button class="capture-btn" id="captureBtn"></button>
                
                <button class="control-btn switch-btn" id="switchBtn" title="Switch Camera">ðŸ”„</button>
            </div>
        </div>
    </div>

    <div class="photos-grid" id="photosGrid">
        <div class="photos-header">
            <h2>Photos</h2>
            <button class="control-btn" id="closeGallery">âœ•</button>
        </div>
        <div class="photos-container" id="photosContainer"></div>
    </div>

    <div class="error-message" id="errorMessage" style="display: none;">
        <h3>Camera Access Required</h3>
        <p>Please allow camera access to use this app</p>
        <button onclick="requestCameraAccess()">Try Again</button>
    </div>

    <script>
        class CameraApp {
            constructor() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.captureBtn = document.getElementById('captureBtn');
                this.switchBtn = document.getElementById('switchBtn');
                this.galleryBtn = document.getElementById('galleryBtn');
                this.flashOverlay = document.getElementById('flashOverlay');
                this.photosGrid = document.getElementById('photosGrid');
                this.photosContainer = document.getElementById('photosContainer');
                this.closeGallery = document.getElementById('closeGallery');
                this.errorMessage = document.getElementById('errorMessage');

                this.stream = null;
                this.currentCamera = 'user'; // 'user' for front, 'environment' for back
                this.currentMode = 'photo';
                this.isRecording = false;
                this.mediaRecorder = null;
                this.photos = JSON.parse(localStorage.getItem('cameraPhotos') || '[]');
                this.currentZoom = 1;

                this.init();
            }

            async init() {
                try {
                    await this.requestCameraAccess();
                    this.setupEventListeners();
                    this.updateGalleryPreview();
                    this.setupTouchGestures();
                    this.updateZoomButtons();
                } catch (error) {
                    this.showError('Failed to access camera: ' + error.message);
                }
            }

            async requestCameraAccess() {
                try {
                    const constraints = {
                        video: {
                            facingMode: this.currentCamera,
                            width: { ideal: 4096 },
                            height: { ideal: 2160 },
                            frameRate: { ideal: 60 }
                        },
                        audio: true
                    };

                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.stream;
                    
                    // Hide error message if shown
                    this.errorMessage.style.display = 'none';
                } catch (error) {
                    throw new Error('Camera access denied or not available');
                }
            }

            setupEventListeners() {
                // Capture button
                this.captureBtn.addEventListener('click', () => {
                    if (this.currentMode === 'photo') {
                        this.takePhoto();
                    } else if (this.currentMode === 'video') {
                        this.toggleVideoRecording();
                    }
                });

                // Switch camera
                this.switchBtn.addEventListener('click', () => this.switchCamera());

                // Gallery
                this.galleryBtn.addEventListener('click', () => this.openGallery());
                this.closeGallery.addEventListener('click', () => this.closeGalleryView());

                // Mode selection
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.switchMode(e.target.dataset.mode);
                    });
                });

                // Zoom buttons
                document.querySelectorAll('.zoom-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const zoomLevel = parseFloat(e.target.dataset.zoom);
                        this.setZoom(zoomLevel);
                        this.updateZoomButtons();
                    });
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    switch(e.code) {
                        case 'Space':
                            e.preventDefault();
                            this.captureBtn.click();
                            break;
                    }
                });
            }

            setupTouchGestures() {
                let startDistance = 0;
                let startZoom = 1;

                this.video.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 2) {
                        startDistance = this.getDistance(e.touches[0], e.touches[1]);
                        startZoom = this.currentZoom;
                    }
                });

                this.video.addEventListener('touchmove', (e) => {
                    if (e.touches.length === 2) {
                        e.preventDefault();
                        const currentDistance = this.getDistance(e.touches[0], e.touches[1]);
                        const scale = currentDistance / startDistance;
                        const newZoom = Math.min(8, Math.max(1, startZoom * scale));
                        this.setZoom(newZoom);
                        this.updateZoomButtons();
                    }
                });
            }

            getDistance(touch1, touch2) {
                return Math.sqrt(
                    Math.pow(touch2.clientX - touch1.clientX, 2) +
                    Math.pow(touch2.clientY - touch1.clientY, 2)
                );
            }
setZoom(zoom) {
    this.currentZoom = zoom;
    this.video.style.transform = `scale(${zoom})`;
    // That's all! Ignore camera track zoom APIs.
}

// Replace takePhoto function
async takePhoto() {
    // Flash effect
    this.flashOverlay.classList.add('active');
    setTimeout(() => {
        this.flashOverlay.classList.remove('active');
    }, 200);

    // Setup
    const video = this.video;
    const zoom = this.currentZoom;
    const vw = video.videoWidth;
    const vh = video.videoHeight;

    // Crop to zoomed region (centered)
    const w = vw / zoom;
    const h = vh / zoom;
    const sx = (vw - w) / 2;
    const sy = (vh - h) / 2;

    this.canvas.width = w;
    this.canvas.height = h;
    const ctx = this.canvas.getContext('2d');
    ctx.drawImage(video, sx, sy, w, h, 0, 0, w, h);

    const dataURL = this.canvas.toDataURL('image/jpeg', 0.9);
    const photo = {
        id: Date.now(),
        dataURL: dataURL,
        timestamp: new Date().toISOString()
    };

    this.photos.unshift(photo);
    localStorage.setItem('cameraPhotos', JSON.stringify(this.photos));
    this.updateGalleryPreview();

    this.captureBtn.style.transform = 'scale(0.9)';
    setTimeout(() => {
        this.captureBtn.style.transform = 'scale(1)';
    }, 100);
}
            updateZoomButtons() {
                document.querySelectorAll('.zoom-btn').forEach(btn => {
                    const zoomLevel = parseFloat(btn.dataset.zoom);
                    if (zoomLevel === this.currentZoom) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }



            async toggleVideoRecording() {
                if (!this.isRecording) {
                    // Start recording
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: this.currentCamera },
                            audio: true
                        });

                        this.mediaRecorder = new MediaRecorder(stream);
                        const chunks = [];

                        this.mediaRecorder.ondataavailable = (e) => {
                            if (e.data.size > 0) {
                                chunks.push(e.data);
                            }
                        };

                        this.mediaRecorder.onstop = () => {
                            const blob = new Blob(chunks, { type: 'video/webm' });
                            const url = URL.createObjectURL(blob);
                            const video = {
                                id: Date.now(),
                                dataURL: url,
                                timestamp: new Date().toISOString(),
                                type: 'video'
                            };

                            this.photos.unshift(video);
                            localStorage.setItem('cameraPhotos', JSON.stringify(this.photos));
                            this.updateGalleryPreview();
                        };

                        this.mediaRecorder.start();
                        this.isRecording = true;
                        this.captureBtn.classList.add('recording');
                    } catch (error) {
                        console.error('Error starting video recording:', error);
                    }
                } else {
                    // Stop recording
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    this.captureBtn.classList.remove('recording');
                }
            }

            async switchCamera() {
                this.currentCamera = this.currentCamera === 'user' ? 'environment' : 'user';
                
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }

                try {
                    await this.requestCameraAccess();
                } catch (error) {
                    this.showError('Failed to switch camera');
                }
            }

            switchMode(mode) {
                this.currentMode = mode;
                
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-mode="${mode}"]`).classList.add('active');

                // Update capture button appearance based on mode
                if (mode === 'video') {
                    this.captureBtn.style.borderRadius = '12px';
                } else {
                    this.captureBtn.style.borderRadius = '50%';
                }
            }

            updateGalleryPreview() {
                if (this.photos.length > 0) {
                    const latestPhoto = this.photos[0];
                    const img = document.createElement('img');
                    img.src = latestPhoto.dataURL;
                    img.alt = 'Latest photo';
                    this.galleryBtn.innerHTML = '';
                    this.galleryBtn.appendChild(img);
                } else {
                    this.galleryBtn.innerHTML = 'ðŸ“·';
                }
            }

            openGallery() {
                this.photosGrid.classList.add('active');
                this.renderPhotos();
            }

            closeGalleryView() {
                this.photosGrid.classList.remove('active');
            }

            deletePhoto(photoId) {
                this.photos = this.photos.filter(photo => photo.id !== photoId);
                localStorage.setItem('cameraPhotos', JSON.stringify(this.photos));
                this.updateGalleryPreview();
                this.renderPhotos();
            }

            renderPhotos() {
                this.photosContainer.innerHTML = this.photos.map(photo => 
                    `<div class="photo-item" onclick="viewPhoto(${photo.id})">
                        ${photo.type === 'video' ? 
                            `<video src="${photo.dataURL}" muted></video>` :
                            `<img src="${photo.dataURL}" alt="Photo">`
                        }
                        <button class="delete-btn" onclick="event.stopPropagation(); deletePhoto(${photo.id})">âœ•</button>
                    </div>`
                ).join('');
            }

            showError(message) {
                this.errorMessage.querySelector('p').textContent = message;
                this.errorMessage.style.display = 'block';
            }
        }

        // Initialize app when page loads
        let cameraApp;
        
        window.addEventListener('load', () => {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                cameraApp = new CameraApp();
            } else {
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').querySelector('p').textContent = 
                    'Camera not supported in this browser';
            }
        });

        // Global functions
        function requestCameraAccess() {
            if (cameraApp) {
                cameraApp.requestCameraAccess();
            }
        }

        function viewPhoto(photoId) {
            const photo = cameraApp.photos.find(p => p.id == photoId);
            if (photo) {
                const viewer = document.createElement('div');
                viewer.style.position = 'fixed';
                viewer.style.top = '0';
                viewer.style.left = '0';
                viewer.style.right = '0';
                viewer.style.bottom = '0';
                viewer.style.background = 'rgba(0,0,0,0.9)';
                viewer.style.zIndex = '100';
                viewer.style.display = 'flex';
                viewer.style.justifyContent = 'center';
                viewer.style.alignItems = 'center';
                viewer.style.flexDirection = 'column';
                
                let mediaElement;
                if (photo.type === 'video') {
                    mediaElement = document.createElement('video');
                    mediaElement.src = photo.dataURL;
                    mediaElement.controls = true;
                    mediaElement.autoplay = true;
                } else {
                    mediaElement = document.createElement('img');
                    mediaElement.src = photo.dataURL;
                }
                
                mediaElement.style.maxWidth = '90%';
                mediaElement.style.maxHeight = '80%';
                mediaElement.style.objectFit = 'contain';
                
                const closeBtn = document.createElement('button');
                closeBtn.textContent = 'Close';
                closeBtn.style.marginTop = '20px';
                closeBtn.style.padding = '10px 20px';
                closeBtn.style.background = 'rgba(255,255,255,0.2)';
                closeBtn.style.color = 'white';
                closeBtn.style.border = 'none';
                closeBtn.style.borderRadius = '5px';
                closeBtn.style.cursor = 'pointer';
                closeBtn.onclick = () => {
                    document.body.removeChild(viewer);
                };
                
                viewer.appendChild(mediaElement);
                viewer.appendChild(closeBtn);
                viewer.onclick = (e) => {
                    if (e.target === viewer) {
                        document.body.removeChild(viewer);
                    }
                };
                
                document.body.appendChild(viewer);
            }
        }

        function deletePhoto(photoId) {
            if (cameraApp && confirm('Are you sure you want to delete this photo?')) {
                cameraApp.deletePhoto(photoId);
            }
        }

        // Service worker for offline support (optional)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(console.error);
        }
    </script>
</body>
</html>
